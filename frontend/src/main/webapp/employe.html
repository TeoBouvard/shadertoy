<!DOCTYPE html>
<html>

    <head>
        <title>Positif</title>
        <meta charset="UTF-8">

        <!-- Librairie Javascript: jQuery (v3.3.1) -->
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <link rel="stylesheet" type="text/CSS" href="client.css">
        <!-- TODO CSS : section voyance invisible jusqu'à click sur "Je suis prêt" -->
    </head>

    <body>
        <div id="bloc-page">
            <h1> AstroNet </h1>
            <p id="employe">Bonjour, </p><br>
            <div id="section-client">
                <h2>Client</h2>
                <label id="nom-client"> </label><br>
                <label id="prenom-client"> </label><br>
                <label id="medium"> </label><br>
                <label id="couleur"></label><br>
                <label id="zodiaque"></label><br>
                <label id="chinois"></label><br>
                <label id="animal"></label><br>
                <table id="historique"></table>
            </div><br>

            <div id="boutons-centre">
                <button id="pret" onclick="DemarrerVoyance()">Je suis prêt</button>
                <button id="stats" onclick="location = 'statistiques.html'">Statistiques</button>
                <button id="deconnecter" onclick="Deconnecter()">Se déconnecter</button>
            </div><br>

            <div id="section-voyance">
                <button id="debut-appel" onclick="DebutAppel()">Début appel</button>
                <button id="fin-appel" onclick="FinAppel()">Fin appel</button> <br>
                Générateur : <br>
                <input id="note-amour" placeholder="Note amour" type="number" max="5" min="1" value="3" required>
                <input id="note-sante" placeholder="Note santé" type="number" max="5" min="1" value="3" required>
                <input id="note-travail" placeholder="Note travail" type="number" max="5" min="1" value="3" required><br>
                <button id="generer-predictions" onclick="GenererPredictions()"> Générer </button><br>
                <table id="predictions">
                    <tr>
                        <th>Catégorie</th>
                        <th>Prédiction</th>
                    </tr>
                    <tr>
                        <th>Amour</th>
                        <td id="pred-amour"></td>
                    </tr>
                    <tr>
                        <th>Santé</th>
                        <td id="pred-sante"></td>
                    </tr>
                    <tr>
                        <th>Travail</th>
                        <td id="pred-travail"></td>
                    </tr>
                </table>
                <input id="commentaire-employe" placeholder="Laisser un commentaire sur la voyance" type="text">
                <button id="valider-voyance" onclick="ValiderVoyance()">Valider la voyance</button>
            </div>

        </div>

        <script>
            $(document).ready(function () {
                GetInfoEmploye();
                GetVoyanceEnCours();
            });

            var dateDebutAppel;
            var dateFinAppel;

            function GetInfoEmploye() {
                $.ajax({
                    url: './ActionServlet', // URL
                    method: 'POST', // Méthode
                    data: {// Paramètres
                        todo: 'infos-employe'
                    },
                    dataType: 'json'        // Type de retour attendu
                }).done(function (response) {
                    $('#employe').append(response.prenom + " " + response.nom);
                });
            }

            function GetVoyanceEnCours()
            {
                $.ajax({
                    url: './ActionServlet', // URL
                    method: 'POST', // Méthode
                    data: {// Paramètres
                        todo: 'voyance-en-cours'
                    },
                    dataType: 'json'        // Type de retour attendu
                }).done(function (response) {
                    if (response.statut) {
                        $("#nom-client").html(response.nomClient);
                        $("#prenom-client").html(response.prenomClient);
                        $("#medium").html(response.medium);
                        $("#couleur").html(response.couleur);
                        $("#zodiaque").html(response.zodiaque);
                        $("#chinois").html(response.chinois);
                        $("#animal").html(response.animal);
                        $("#pret").prop('disabled', false);

                        $.each(response.listeVoyance.slice().reverse(), function (i, voyance) {
                            $("#historique").append("<tr> <td>" + voyance.medium + "</td>" + "<td>" + voyance.dateDebut + "</td>" + "<td>" + voyance.dateFin + "</td>" + "<td>" + voyance.commentaire + "</tr>");
                        });
                    } else {
                        $("#medium").html("Vous n'avez aucune demande de voyance en attente");
                        $("#nom-client").empty();
                        $("#prenom-client").empty();
                        $("#couleur").empty();
                        $("#zodiaque").empty();
                        $("#chinois").empty();
                        $("#animal").empty();
                        $("#historique").empty();
                        $("#pret").prop('disabled', true);
                    }
                    $("#debut-appel").prop('disabled', true);
                    $("#fin-appel").prop('disabled', true);
                    $("#generer-predictions").prop('disabled', true);
                    $("#valider-voyance").prop('disabled', true);
                    $("#stats").prop('disabled', false);
                    $("#deconnecter").prop('disabled', false);
                }).fail(function (error) {
                    alert(error.statusText);
                });
            }

            function DemarrerVoyance()
            {
                $.ajax({
                    url: './ActionServlet', // URL
                    method: 'POST', // Méthode
                    data: {// Paramètres
                        todo: 'demarrer-voyance'
                    },
                    dataType: 'json'        // Type de retour attendu
                }).done(function (response) {
                    if (response.statut) {
                        $("#pret").prop('disabled', true);
                        $("#stats").prop('disabled', true);
                        $("#deconnecter").prop('disabled', true);
                        $("#debut-appel").prop('disabled', false);
                        $("#fin-appel").prop('disabled', true);
                        $("#valider-voyance").prop('disabled', true);
                    } else {
                        alert("Impossible de démarrer la voyance");
                    }
                }).fail(function (error) {
                    alert(error.statusText);
                });
            }

            function DebutAppel() {
                let date = new Date();
                dateDebutAppel = date.getFullYear() + "-" + (appendLeadingZeroes(date.getMonth() + 1)) + "-" + appendLeadingZeroes(date.getDate()) + "T" + appendLeadingZeroes(date.getHours()) + ":" + appendLeadingZeroes(date.getMinutes()) + ":" + appendLeadingZeroes(date.getSeconds());
                console.log(dateDebutAppel);
                $("#debut-appel").prop('disabled', true);
                $("#fin-appel").prop('disabled', false);
                $("#pret").prop('disabled', true);
                $("#generer-predictions").prop('disabled', false);
            }

            function FinAppel() {
                let date = new Date();
                dateFinAppel = date.getFullYear() + "-" + (appendLeadingZeroes(date.getMonth() + 1)) + "-" + appendLeadingZeroes(date.getDate()) + "T" + appendLeadingZeroes(date.getHours()) + ":" + appendLeadingZeroes(date.getMinutes()) + ":" + appendLeadingZeroes(date.getSeconds());
                console.log(dateFinAppel);
                $("#debut-appel").prop('disabled', false);
                $("#pret").prop('disabled', true);
                $("#stats").prop('disabled', true);
                $("#deconnecter").prop('disabled', true);
                $("#debut-appel").prop('disabled', true);
                $("#fin-appel").prop('disabled', true);
                $("#valider-voyance").prop('disabled', false);
            }

            function ValiderVoyance() {
                var commentaire = $("#commentaire-employe").val();
                console.log(commentaire);

                $.ajax({
                    url: './ActionServlet', // URL
                    method: 'POST', // Méthode
                    data: {// Paramètres
                        todo: 'valider-voyance',
                        commentaire: commentaire,
                        dateDebutAppel: dateDebutAppel,
                        dateFinAppel: dateFinAppel
                    },
                    dataType: 'json'        // Type de retour attendu
                }).done(function (response) {
                    if (response.statut) {
                        $("#pred-amour").empty();
                        $("#pred-sante").empty();
                        $("#pred-travail").empty();
                        document.getElementById("commentaire-employe").value = "";
                        GetVoyanceEnCours();
                    } else {
                        alert("Impossible de valider la voyance");
                    }
                }).fail(function () {
                    alert("Impossible de valider la voyance");
                });
            }

            function GenererPredictions() {
                $("#debut-appel").prop('disabled', false);
                $("#pret").prop('disabled', true);
                $("#stats").prop('disabled', true);
                $("#deconnecter").prop('disabled', true);
                $("#debut-appel").prop('disabled', true);

                var noteAmour = $("#note-amour").val();
                var noteSante = $("#note-sante").val();
                var noteTravail = $("#note-travail").val();

                $.ajax({
                    url: './ActionServlet', // URL
                    method: 'POST', // Méthode
                    data: {// Paramètres
                        todo: 'generer-predictions',
                        noteAmour: noteAmour,
                        noteSante: noteSante,
                        noteTravail: noteTravail
                    },
                    dataType: 'json'        // Type de retour attendu
                }).done(function (response) {
                    $("#pred-amour").html(response.predAmour);
                    $("#pred-sante").html(response.predSante);
                    $("#pred-travail").html(response.predTravail);
                }).fail(function () {
                    alert("Impossible de générer les prédictions");
                });
            }

            function Deconnecter() {
                $.ajax({
                    url: './ActionServlet', // URL
                    method: 'POST', // Méthode
                    data: {// Paramètres
                        todo: 'deconnecter'
                    },
                    dataType: 'html'        // Type de retour attendu
                }).done(function () {
                    window.location = "index.html";
                }).fail(function () {
                    alert("Erreur lors de la déconnexion");
                });
            }

            function appendLeadingZeroes(n) {
                if (n <= 9) {
                    return "0" + n;
                }
                return n
            }
        </script>

    </body>

</html>